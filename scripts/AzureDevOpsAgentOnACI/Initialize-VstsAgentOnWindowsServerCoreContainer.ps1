##################################################################################################################
# Script Disclaimer
##################################################################################################################
# This script is not supported under any Microsoft standard support program or service.
# This script is provided AS IS without warranty of any kind.
# Microsoft disclaims all implied warranties including, without limitation, any implied warranties of
# merchantability or of fitness for a particular purpose. The entire risk arising out of the use or
# performance of this script and documentation remains with you. In no event shall Microsoft, its authors,
# or anyone else involved in the creation, production, or delivery of this script be liable for any damages
# whatsoever (including, without limitation, damages for loss of business profits, business interruption,
# loss of business information, or other pecuniary loss) arising out of the use of or inability to use
# this script or documentation, even if Microsoft has been advised of the possibility of such damages.

<#
.SYNOPSIS
    This script creates ACI container instance(s) which run the Azure DevOps (formerly VSTS) Agent, alongside with the requested 
    PowerShell modules and Terraform to enable Azure resource build automation from Azure DevOps CI/CD pipelines.
.DESCRIPTION
    This script is used as a wrapper of the container configuration script 
    ("Install-VstsAgentOnWindowsServerCoreContainer.ps1") to create ACI container instance(s) which run 
    the Azure DevOps Agent, alongside with the requested PowerShell modules and Terraform to enable Azure resource build 
    automation from Azure DevOps CI/CD pipelines.
    
    It copies the container configuration script to a publicly available storage container of the requested
    Storage Acccount, it creates a new Resource Group (if one doesn't exist with the provided name), removes
    any pre-existing ACI containers with the same name, within the same Resource Group, then creates new ACI
    container instance(s) based on the provided names and invokes the container configuration script inside the
    container(s).
    
    This script is designed and tested to be run from Azure Cloud Shell.
    Prerequisites: 
    - Azure Subscription, with an existing Storage Account
    - You need to have **admin rights** :
    - to create a storage container within the already existing Storage Account *- OR -*  you need to have 
      a storage container which has its public access type configured to the type of "Blob",
    - to create a new Resource Group *- OR -*  an existing Resource Group for the Azure Container Intances,
    - to create resources in the selected Resource Group.
    - Azure DevOps account with the requested Agent Pool has to exist.
    - Permission in the Azure DevOps account to add Agents to the chosen Agent Pool.
    - A PAT token.
.PARAMETER SubscriptionName
    Name of the Subscription.
.PARAMETER ResourceGroupName
    Name of the Resource Group.
.PARAMETER ContainerName
    Name of the ACI container(s).
.PARAMETER ReplaceExistingContainer
    Switch to replace existing container(s) with the same name(s) provided.
.PARAMETER MemoryInGB
    Amount of memory in GBs.
.PARAMETER Cpu
    Number of CPU cores.
.PARAMETER Location
    Region of the Azure resources.
.PARAMETER StorageAccountName
    Name of the Storage Account to upload the script file to, which is then invoke by this wrapper.
.PARAMETER StorageContainerName
    Name of the storage container to upload the scriptfile to be invoked by this wrapper.
.PARAMETER ScriptFileName
    Name of the script file to invoke by this wrapper.
.PARAMETER VSTSAccountName
    Name of the Azure Devops account - formerly Visual Studio Team Services (VSTS) account, e.g. https://<Azure DevOps Account Name>.visualstudio.com - OR - https://dev.azure.com/<Azure DevOps Account Name>/
.PARAMETER PATToken
    PPAT token generated by the user who is configuring the container to be used by Azure Devops.
.PARAMETER PoolName
    Name of the Agent pool. It defaults to the "Default" pool when not defined.
.PARAMETER RequiredPowerShellModules
    List of the required PowerShell modules, e.g. AzureRM, AzureAD, Pester
.EXAMPLE
    .\Initialize-VstsAgentOnWindowsServerCoreContainer.ps1 -SubscriptionName "<subscription name>" -ResourceGroupName "<resource group name>" -ContainerName "<container 1 name>", "<container 2 name>" -Location "<azure region>" -StorageAccountName "<storage account name>" -VSTSAccountName "<azure devops account name>" -PATToken "<PAT token>"
    This creates uploads the container configuration script to the default "publicvstsscript" storage container of the requested Storage Account and then creates 2 Azure Container Instances, with the default settings (Default Agent Pool 1 GB RAM, 1 CPU core, PowerShell modules installed: "AzureRM", "AzureAD", "Pester").
.EXAMPLE
    .\Initialize-VstsAgentOnWindowsServerCoreContainer.ps1 -SubscriptionName "<subscription name>" -ResourceGroupName "<resource group name>" -ContainerName "<container 1 name>", "<container 2 name>" -Location "<azure region>" -StorageAccountName "<storage account name>" -StorageContainerName "publicvstsscript" -MemoryInGB 1 -Cpu 1 -ScriptFileName "Install-VstsAgentOnWindowsServerCoreContainer.ps1" -VSTSAccountName "<Azure DevOps Account name>" -PATToken "<PAT token>" -PoolName "<Azure DevOps Agent Pool name>" -RequiredPowerShellModules "AzureRM", "AzureAD", "Pester"
    This installs 2 Azure Container Instances with all the possible values manually defined.
.EXAMPLE
    .\Initialize-VstsAgentOnWindowsServerCoreContainer.ps1 -SubscriptionName "<subscription name>" -ResourceGroupName "<resource group name>" -ContainerName "<container 1 name>", "<container 2 name>" -Location "<azure region 2>" -StorageAccountName "<storage account name>" -VSTSAccountName "<azure devops account name>" -PATToken "<PAT token>" -PoolName "<agent pool name>" -ReplaceExistingContainer
    This removes any existing ACI containers with the provided names, then creates new ones with the requested values.
.INPUTS
    <none>
.OUTPUTS
    <none>
.NOTES
    Version:        1.0
    Author:         Mate Barabas
    Creation Date:  2018-08-29
#>

param(

    [Parameter(Mandatory=$true,
               HelpMessage="Name of the Subscription.")]
    [ValidateNotNullOrEmpty()]
    [string]$SubscriptionName,

    [Parameter(Mandatory=$true,
               HelpMessage="Name of the Resource Group.")]
    [ValidateNotNullOrEmpty()]
    [string]$ResourceGroupName,

    [Parameter(Mandatory=$false,
               HelpMessage="Name of the ACI container(s).")]
    [ValidateNotNullOrEmpty()]
    [array]$ContainerName,

    [Parameter(Mandatory=$false,
               HelpMessage="Switch to replace existing container(s) with the same name(s) provided.")]
    [ValidateNotNullOrEmpty()]
    [switch]$ReplaceExistingContainer,

    [Parameter(Mandatory=$false,
               HelpMessage="Amount of memory in GBs.")]
    [ValidateNotNullOrEmpty()]
    [string]$MemoryInGB=1,
    
    [Parameter(Mandatory=$false,
               HelpMessage="Number of CPU cores.")]
    [ValidateNotNullOrEmpty()]
    [string]$Cpu=1,

    [Parameter(Mandatory=$true,
               HelpMessage="Region of the Azure resources.")]
    [ValidateNotNullOrEmpty()]
    [string]$Location,

    [Parameter(Mandatory=$true,
               HelpMessage="Name of the Storage Account to upload the script file to, which is then invoke by this wrapper.")]
    [ValidateNotNullOrEmpty()]
    [string]$StorageAccountName,

    [Parameter(Mandatory=$false,
               HelpMessage="Name of the storage container to upload the scriptfile to be invoked by this wrapper.")]
    [ValidateNotNullOrEmpty()]
    [string]$StorageContainerName="publicvstsscript",
    
    [Parameter(Mandatory=$false,
               HelpMessage="Name of the script file to invoke by this wrapper.")]
    [ValidateNotNullOrEmpty()]
    [string]$ScriptFileName="Install-VstsAgentOnWindowsServerCoreContainer.ps1",

    [Parameter(Mandatory=$true,
               HelpMessage="Name of the Visual Studio Team Services Account (VSTS), e.g. https://<VSTSAccountName>.visualstudio.com")]
    [ValidateNotNullOrEmpty()]
    [string]$VSTSAccountName,

    [Parameter(Mandatory=$true,
               HelpMessage="PAT token generated by the user who is configuring the container to be used by VSTS.")]
    [ValidateNotNullOrEmpty()]
    [string]$PATToken,

    [Parameter(Mandatory=$false,
               HelpMessage="Name of the Agent pool. It defaults to the ""Default"" pool when not defined.")]
    [ValidateNotNullOrEmpty()]
    [string]$PoolName="Default",

    [Parameter(Mandatory=$false,
               HelpMessage="List of the required PowerShell modules, e.g. AzureRM, AzureAD, Pester")]
    [ValidateNotNullOrEmpty()]
    [array]$RequiredPowerShellModules=@("AzureRM", "AzureAD", "Pester")

)

#region Functions
    function Set-AzureContext {

        param (

            [Parameter(Mandatory=$false)][string]$SubscriptionName

        )

        # Select the desired Subscription based on the Subscription name provided
        if ($SubscriptionName)
        {
            $Subscription = (Get-AzureRmSubscription | Where-Object {$_.Name -eq $SubscriptionName})
            
            if (-not $Subscription)
            {
                Write-Error "There's no Subscription available with the provided name."
                return
            }
            else
            {
                $SubscriptionId = $Subscription.Id
                Select-AzureRmSubscription -SubscriptionId $SubscriptionId| Out-Null
                Write-Output "The following subscription was selected: ""$SubscriptionName"""
            }
        }
        # If no Subscription name was provided select the active Subscription based on the existing context
        else
        {
            $SubscriptionName = (Get-AzureRmContext).Subscription.Name
            $Subscription = (Get-AzureRmSubscription | Where-Object {$_.Name -eq $SubscriptionName})
            Write-Output "The following subscription was selected: ""$SubscriptionName"""
        }

        if ($Subscription.Count -gt 1)
        {
            Write-Error "You have more then 1 Subscription with the same name. Exiting..."
            return
        }
    }

    function Copy-ScriptToStorageAccount {

        param (

            [Parameter(Mandatory=$true)][string]$StorageAccountName,
            [Parameter(Mandatory=$false)][string]$StorageContainerName="publicvstsscript",
            [Parameter(Mandatory=$false)][string]$ScriptFileName="Install-VstsAgentOnWindowsServerCoreContainer.ps1"

        )

        # Check if the Install-VstsAgentOnWindowsServerCoreContainer.ps1 script exists within the same folder
        if (-not (Get-Item -Path ".\$ScriptFileName" -ErrorAction SilentlyContinue))
        {
            Write-Error "The script to be uploaded to the Storage Account ($ScriptFileName) does not exist in the same folder. Make sure that it is copied to the same folder along with the Initialize-VstsAgentOnWindowsServerCoreContainer.ps1 script. Exiting..."
            break
        }

        # Getting the Resource Group Name of the Storage Account
        Write-Output "Getting the Resource Group Name of the Storage Account ($StorageAccountName)..."
        $StorageAccountResourceGroupName = (Get-AzureRmStorageAccount | Where-Object {$_.StorageAccountName -eq $StorageAccountName}).ResourceGroupName

        if (-not $StorageAccountResourceGroupName)
        {
            Write-Error "The selected Storage Account does not exist. Exiting..."
            break
        }

        # Getting Storage Account Key
        Write-Output "Getting Storage Account Key..."
        $StorageKey = Get-AzureRmStorageAccountKey -ResourceGroupName $StorageAccountResourceGroupName -Name $StorageAccountName

        # Setting storage context
        Write-Output "Setting storage context..."
        $ctx = New-AzureStorageContext -StorageAccountName  $StorageAccountName -StorageAccountKey $StorageKey[0].Value

        # Checking if the container exists, creating if it doesn't
        $StorageContainer = Get-AzureStorageContainer -Context $ctx -Name $StorageContainerName -ErrorAction SilentlyContinue
        if (-not $StorageContainer)
        {
            Write-Output "Storage container ""$StorageContainerName"" does not exist in the ""$StorageAccountName"" Storage Account. Creating storage container with public access..."
            New-AzureStorageContainer -Context $ctx -Name $StorageContainerName -Permission Blob | Out-Null
            Write-Output "Wait 10 seconds..."
            Start-Sleep -Seconds 10
        }
        else
        {
            Write-Output "Storage container ""$StorageContainerName"" exists in the ""$StorageAccountName"" Storage Account."
            $PublicAccess = (Get-AzureStorageContainerAcl -Name $StorageContainerName -Context $ctx).PublicAccess
            if ($PublicAccess -ne "Blob")
            {
                Write-Output "Public Access was configured to $PublicAccess. Resetting it to ""Blob"" (public access)."
                Set-AzureStorageContainerAcl -Name $StorageContainerName -Permission Blob
                Write-Output "Wait 10 seconds..."
                Start-Sleep -Seconds 10
            }
        }

        # Check if container creation was successful
        $StorageContainer = Get-AzureStorageContainer -Context $ctx -Name $StorageContainerName -ErrorAction SilentlyContinue
        if (-not $StorageContainer)
        {
            Write-Error "Storage container ($StorageContainerName) could not be created in the $StorageAccountName Storage Account. Exiting..."
            break
        }

        # Uploading CSV file
        Write-Output "Uploading the Install-VstsAgentOnWindowsServerCoreContainer.ps1 script to the Storage Account..."
        Set-AzureStorageBlobContent -Container $StorageContainerName -File $ScriptFileName -Blob $ScriptFileName -context $ctx -Force | Out-Null

        # Checking success
        $Blob = Get-AzureStorageBlob -Context $ctx -Container $StorageContainerName -Blob $ScriptFileName -ErrorAction SilentlyContinue
        if ($Blob)
        {
            Write-Output "The script file ($ScriptFileName) was successfully uploaded to the ""$StorageContainerName"" container of the ""$StorageAccountName"" Storage Account in the ""$StorageAccountResourceGroupName"" Resource Group."
        }
        else
        {
            Write-Error "The script file ($ScriptFileName) could not be uploaded to the ""$StorageContainerName"" container of the ""$StorageAccountName"" Storage Account in the ""$StorageAccountResourceGroupName"" Resource Group. Exiting..."
            break
        }

    }

    function New-Container {
        # Create & Install containers
        $ScriptURL = "https://$StorageAccountName.blob.core.windows.net/$StorageContainerName/$ScriptFileName"

        foreach ($Name in $ContainerName)
        {
            $CanCreateContainerWithProvidedName = $true
            $ExistingContainer = Get-AzureRmContainerGroup -ResourceGroupName $ResourceGroupName -Name $Name -ErrorAction SilentlyContinue
            if ($ExistingContainer)
            {
                Write-Warning "ACI container with the requested name ($Name) already exists in the given Resource Group ($ResourceGroupName)."
                $CanCreateContainerWithProvidedName = $false
                if ($ReplaceExistingContainer.IsPresent)
                {
                    Write-Warning "Deleting the existing container instance ($Name)..."
                    Remove-AzureRmContainerGroup -ResourceGroupName $ResourceGroupName -Name $Name -Confirm:$false
                    $ContainerDeletetionWasRequired = $true
                    $CanCreateContainerWithProvidedName = $true
                    Write-Output "Waiting 10 seconds..."
                    Start-Sleep -Seconds 10
                }
                else
                {
                    Write-Output "Existing container with the name of $Name is being kept."
                }
            }
            if ($CanCreateContainerWithProvidedName)
            {
                $CreateAtLeastOneContainer = $true
                Write-Host "Creating ACI container ($Name)..."
                
                # The AZ CLI has to be used, as the required -Command parameter is note available in the core version of the related AzureRM PowerShell module in Azure Cloud Shell.
                az container create --resource-group $ResourceGroupName --name $Name --image "microsoft/windowsservercore" --location $Location --os-type Windows --cpu $Cpu --memory $MemoryInGB --restart-policy Always --command-line "powershell Start-Sleep -Seconds 20; Invoke-WebRequest -Uri $ScriptURL -OutFile $ScriptFileName -UseBasicParsing; & .\\$ScriptFileName -VSTSAccountName $VSTSAccountName -PATToken $PATToken -AgentNamePrefix $Name -PoolName $PoolName" --subscription $SubscriptionName
                
                # Alternative option, using AzureRM PowerShell commandlet (this doesn't work in Azure Cloud Shell, as the -Command parameter is not available in the core version of this cmdlet)
                # New-AzureRmContainerGroup -ResourceGroupName $ResourceGroupName `
                #                           -Name $Name `
                #                           -Image "microsoft/windowsservercore" `
                #                           -Location $Location `
                #                           -OsType Windows `
                #                           -Cpu $Cpu `
                #                           -MemoryInGB $MemoryInGB `
                #                           -RestartPolicy Always `
                #                           -Command "powershell Start-Sleep -Seconds 20; Invoke-WebRequest -Uri $ScriptURL -OutFile $ScriptFileName -UseBasicParsing; & .\$ScriptFileName -VSTSAccountName $VSTSAccountName -PATToken $PATToken -AgentNamePrefix $Name -PoolName $PoolName" | Out-null
                
            }
            else
            {
                Write-Warning "ACI container could not be created, as there's another container instance with the same name in the same Resource Group. If you want to remove the existing intance first, run the script again by using the -ReplaceExistingContainer switch."
            }
        }

        if ($CreateAtLeastOneContainer)
        {
            Write-Output "ACI container creation tasks have been submitted. An iteration of creating ACI container(s) usually takes about 10 minutes as these processes run in parallel."
            Write-Output "New ACI container(s) are being built..."

            # Periodically check if all containers have been configured
            $ConfiguredContainers = @()
            $NotificationTracker = @{}
            while ($ConfiguredContainers.Count -ne $ContainerName.Count)
            {
                Start-Sleep -Seconds 60
                foreach ($Name in $ContainerName)
                {
                    if ($ConfiguredContainers -notcontains $Name)
                    {
                        $LogEntries = Get-AzureRmContainerInstanceLog -ResourceGroupName $ResourceGroupName -ContainerGroupName $Name -ErrorAction SilentlyContinue
                        $RestartCount = (Get-AzureRmContainerGroup -ResourceGroupName $ResourceGroupName -Name $Name).Containers.restartcount
                        
                        # Show restart counts, avoid repeating the same entry
                        if ($RestartCount -gt 0)
                        {
                            $Key = "$Name-$RestartCount"
                            if ($NotificationTracker[$Key] -ne "MessageAlreadyShown")
                            {
                                Write-Output "The creation of the ACI container ""$Name"" was restarted $RestartCount time(s). Note that a few retries are acceptable, however each iteration increases the overall creation time."
                                $NotificationTracker.Add($Key,"MessageAlreadyShown")
                            }
                            
                        }

                        # Trigger on success
                        if ($LogEntries)
                        {
                            # Check if the last line of the log is "Container successfully configured."
                            $Success = $LogEntries.Split("`n")[-3] -eq "Container successfully configured." # Do NOT change this value, as the wrapper script is triggered based on this.
                            if ($Success)
                            {
                                $ConfiguredContainers += $Name
                                Write-Output "ACI container ""$Name"" successfully configured"
                            }
                        }
                    }
                }
            }

            # Print results
            if ($ConfiguredContainers.Count -eq $ContainerName.Count)
            {
                Write-Output "All requested containers have been successfully deployed and configured."
                Write-Output "Check if VSTS agents have been registered under the requested Agent Pool on the VSTS portal."
                $TimeSpan = (New-TimeSpan -Start $StartDate -End (Get-Date))
                Write-Output "Finished at $(Get-Date)"
                Write-Output "It took $($TimeSpan.Minutes) minutes and $($TimeSpan.Seconds) seconds to initialize the requested containers."
                if ($ContainerDeletetionWasRequired)
                {
                    Write-Warning "One or more containers have been deleted. Don't forget to clean your Agent pool in VSTS (remove any agents that were created in a previous iteration and are now offline)!"
                }
            }
        }
        else
        {
            Write-Output "No ACI containers have been created, as there were conflicts with existing intances and the -ReplaceExistingContainer was not used."
        }
    }

#endregion

#region Main
    # Report start time
    $StartDate = Get-Date
    Write-Host "Started at $StartDate..."

    # Login to Azure and select Subscription
    Set-AzureContext -SubscriptionName $SubscriptionName

    # Upload the configuration script to a Storage Account
    Copy-ScriptToStorageAccount -StorageAccountName $StorageAccountName -StorageContainerName $StorageContainerName -ScriptFileName $ScriptFileName

    # Create Resource Group for containers
    if (-not (Get-AzureRmResourceGroup -Name $ResourceGroupName -ErrorAction SilentlyContinue))
    {
        Write-Output "Resource Group ""$ResourceGroupName"" does not exist for ACI containers. Creating..."
        New-AzureRmResourceGroup -Name $ResourceGroupName -Location $Location | Out-Null
    }

    # Create containers
    New-Container

#endregion